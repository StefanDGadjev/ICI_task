<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class DataController extends Controller
{
    public function index()
    {
        // URL to where the json data is located
        $api_url = "http://www.google.com";
        // Array to store the processed data
        $data = array();
        // Array to store the processed users data
        $data['users'] = array();

        // Checker if the URL gives json format data and if not returns error
        if (($json_data = @file_get_contents($api_url)) === false) {
            return response()->json(['error' =>'api call went wrong']);
        }

        $json_data = '{"date_time":"2021-05-25T11:22:22.733","eNB_config":[{"LC":{"header":{"type":12,"version":0,"xid":0},"lcUeConfig":[{"lcConfig":[{"direction":2,"lcg":0,"lcid":1,"qci":1,"qosBearerType":0},{"direction":2,"lcg":0,"lcid":2,"qci":1,"qosBearerType":0},{"direction":1,"lcg":0,"lcid":3,"qci":1,"qosBearerType":0}],"rnti":18747}]},"UE":{"ueConfig":[{"ackNackRepetitionFactor":0,"ackNackSimultaneousTrans":0,"aperiodicCqiRepMode":3,"betaOffsetACKIndex":0,"betaOffsetCQIIndex":8,"betaOffsetRIIndex":0,"capabilities":{"halfDuplex":0,"intraSFHopping":1,"resAllocType1":1,"type2Sb1":1,"ueCategory":4},"dlSliceId":0,"extendedBsrSize":4294967295,"imsi":"0","info":{"cellIndividualOffset":["0"],"event":{"a3":{"a3Offset":"0","hysteresis":"0","maxReportCells":"2","reportOnLeave":1,"timeToTrigger":"40"}},"filterCoefficientRsrp":"4","filterCoefficientRsrq":"4","offsetFreqNeighbouring":"0","offsetFreqServing":"0"},"maxHARQTx":4,"measGapConfigPattern":4294967295,"measGapConfigSfOffset":4294967295,"rnti":39962,"simultaneousAckNackCqi":0,"tddAckNackFeedback":4294967295,"timeAlignmentTimer":7,"transmissionMode":0,"ttiBundling":0,"ueAggregatedMaxBitrateDL":"0","ueAggregatedMaxBitrateUL":"0","ueTransmissionAntenna":2,"ulSliceId":0},{"ackNackRepetitionFactor":0,"ackNackSimultaneousTrans":0,"aperiodicCqiRepMode":3,"betaOffsetACKIndex":0,"betaOffsetCQIIndex":8,"betaOffsetRIIndex":0,"capabilities":{"halfDuplex":0,"intraSFHopping":1,"resAllocType1":1,"type2Sb1":1,"ueCategory":4},"dlSliceId":0,"extendedBsrSize":4294967295,"imsi":"0","info":{"cellIndividualOffset":["0"],"event":{"a3":{"a3Offset":"0","hysteresis":"0","maxReportCells":"2","reportOnLeave":1,"timeToTrigger":"40"}},"filterCoefficientRsrp":"4","filterCoefficientRsrq":"4","offsetFreqNeighbouring":"0","offsetFreqServing":"0"},"maxHARQTx":4,"measGapConfigPattern":4294967295,"measGapConfigSfOffset":4294967295,"rnti":15758,"simultaneousAckNackCqi":0,"tddAckNackFeedback":4294967295,"timeAlignmentTimer":7,"transmissionMode":0,"ttiBundling":0,"ueAggregatedMaxBitrateDL":"0","ueAggregatedMaxBitrateUL":"0","ueTransmissionAntenna":2,"ulSliceId":0},{"ackNackRepetitionFactor":0,"ackNackSimultaneousTrans":0,"aperiodicCqiRepMode":3,"betaOffsetACKIndex":0,"betaOffsetCQIIndex":8,"betaOffsetRIIndex":0,"capabilities":{"halfDuplex":0,"intraSFHopping":1,"resAllocType1":1,"type2Sb1":1,"ueCategory":4},"dlSliceId":0,"extendedBsrSize":4294967295,"imsi":"0","info":{"cellIndividualOffset":["0"],"event":{"a3":{"a3Offset":"0","hysteresis":"0","maxReportCells":"2","reportOnLeave":1,"timeToTrigger":"40"}},"filterCoefficientRsrp":"4","filterCoefficientRsrq":"4","offsetFreqNeighbouring":"0","offsetFreqServing":"0"},"maxHARQTx":4,"measGapConfigPattern":4294967295,"measGapConfigSfOffset":4294967295,"rnti":18747,"simultaneousAckNackCqi":0,"tddAckNackFeedback":4294967295,"timeAlignmentTimer":7,"transmissionMode":0,"ttiBundling":0,"ueAggregatedMaxBitrateDL":"0","ueAggregatedMaxBitrateUL":"0","ueTransmissionAntenna":2,"ulSliceId":0}]},"agent_info":[{"agent_id":0,"bs_id":10000,"capabilities":["LOPHY","HIPHY","LOMAC","HIMAC","RLC","PDCP","SDAP","RRC","S1AP"],"ip_port":"192.168.0.102:45520","splits":[]}],"bs_id":10000,"eNB":{"cellConfig":[{"antennaPortsCount":1,"carrierIndex":0,"deltaPUCCHShift":1,"dlBandwidth":100,"dlCyclicPrefixLength":0,"dlFreq":2680,"dlPdschPower":-26,"duplexMode":1,"enable64QAM":0,"eutraBand":7,"hoppingMode":0,"initNrPDCCHOFDMSym":1,"macContentionResolutionTimer":5,"maxHARQMsg3Tx":0,"n1PUCCHAN":0,"nRBCqi":0,"nSb":1,"phichDuration":0,"phichResource":0,"phyCellId":0,"plmnId":[{"mcc":1,"mnc":1,"mncLength":2}],"prachConfigIndex":0,"prachFreqOffset":2,"puschHoppingOffset":0,"raResponseWindowSize":7,"siConfig":{"sfn":137,"siWindowLength":5,"sib1Length":17},"sliceConfig":{},"specialSubframePatterns":0,"srsBwConfig":0,"srsMacUpPts":0,"srsSubframeConfig":0,"subframeAssignment":0,"ulBandwidth":100,"ulCyclicPrefixLength":0,"ulFreq":2560,"ulPuschPower":-96,"x2HoNetControl":false}],"header":{"type":8,"version":0,"xid":0},"s1ap":{"connected":1,"enbName":"eNB-Eurecom-LTEBox","enbS1Ip":"192.168.0.102","mme":[{"name":"open5gs-mme0","relCapacity":255,"requestedPlmns":[{"mcc":1,"mnc":1,"mncLength":2}],"s1Ip":"172.22.0.9","servedGummeis":[{"mmeCode":1,"mmeGroupId":2,"plmn":{"mcc":1,"mnc":1,"mncLength":2}}],"state":"FLMMES_CONNECTED"}],"pending":0}}}],"mac_stats":[{"bs_id":10000,"ue_mac_stats":[{"harq":["ACK","ACK","ACK","ACK","ACK","ACK","ACK","ACK"],"mac_stats":{"bsr":[0,15348,0,0],"dlCqiReport":{"csiReport":[{"p10csi":{"wbCqi":12},"ri":0,"servCellIndex":0,"type":"FLCSIT_P10"}],"sfnSn":1289},"gtpStats":[{"eRabId":5,"teidEnb":2375692390,"teidSgw":2}],"macStats":{"harqRound":3,"macSdusDl":[{"lcid":3,"sduLength":68}],"mcs1Dl":23,"mcs1Ul":20,"mcs2Dl":23,"mcs2Ul":20,"prbDl":4,"prbRetxDl":8,"prbRetxUl":0,"prbUl":0,"tbsDl":77,"tbsUl":1063,"totalBytesSdusDl":8105790,"totalBytesSdusUl":567024,"totalPduDl":2289,"totalPduUl":1116,"totalPrbDl":99564,"totalPrbUl":30706,"totalTbsDl":8346126,"totalTbsUl":1572805},"pdcpStats":{"pktRx":3865,"pktRxAiat":132672,"pktRxAiatW":0,"pktRxBytes":540818,"pktRxBytesW":0,"pktRxOo":0,"pktRxSn":3864,"pktRxW":0,"pktTx":6646,"pktTxAiat":133391,"pktTxAiatW":0,"pktTxBytes":7582673,"pktTxBytesW":0,"pktTxSn":2549,"pktTxW":0,"sfn":"134406"},"pendingMacCes":0,"phr":30,"rlcReport":[{"lcId":1,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":0},{"lcId":2,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":0},{"lcId":3,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":0}],"rnti":15758,"rrcMeasurements":{"measid":-1,"pcellRsrp":-1,"pcellRsrq":-1},"s1apStats":{"enbUeS1apId":7773174,"mmeS1Ip":"172.22.0.9","mmeUeS1apId":3,"selectedPlmn":{"mcc":1,"mnc":1,"mncLength":2}},"ulCqiReport":{"cqiMeas":[{"servCellIndex":0,"type":"FLUCT_SRS"}],"pucchDbm":[{"p0PucchDbm":0,"servCellIndex":0}],"sfnSn":1289}},"rnti":15758},{"harq":["ACK","ACK","ACK","ACK","ACK","ACK","ACK","ACK"],"mac_stats":{"bsr":[0,0,0,0],"dlCqiReport":{"csiReport":[{"p10csi":{"wbCqi":15},"ri":0,"servCellIndex":0,"type":"FLCSIT_P10"}],"sfnSn":2209},"gtpStats":[{"eRabId":5,"teidEnb":4012411690,"teidSgw":2}],"macStats":{"harqRound":8,"macSdusDl":[{"lcid":3,"sduLength":2}],"mcs1Dl":28,"mcs1Ul":10,"mcs2Dl":0,"mcs2Ul":10,"prbDl":4,"prbRetxDl":100,"prbRetxUl":0,"prbUl":0,"tbsDl":11,"tbsUl":63,"totalBytesSdusDl":92257721,"totalBytesSdusUl":3376103,"totalPduDl":16150,"totalPduUl":51541,"totalPrbDl":1030624,"totalPrbUl":230750,"totalTbsDl":93311991,"totalTbsUl":7653886},"pdcpStats":{"pktRx":40380,"pktRxAiat":1431207,"pktRxAiatW":0,"pktRxBytes":3179182,"pktRxBytesW":0,"pktRxOo":0,"pktRxSn":3515,"pktRxW":0,"pktTx":73539,"pktTxAiat":1431184,"pktTxAiatW":0,"pktTxBytes":91913416,"pktTxBytesW":0,"pktTxSn":3906,"pktTxW":0,"sfn":"1435806"},"pendingMacCes":0,"phr":34,"rlcReport":[{"lcId":1,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":0},{"lcId":2,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":0},{"lcId":3,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":0}],"rnti":18747,"rrcMeasurements":{"measid":-1,"pcellRsrp":-1,"pcellRsrq":-1},"s1apStats":{"enbUeS1apId":6840557,"mmeS1Ip":"172.22.0.9","mmeUeS1apId":4,"selectedPlmn":{"mcc":1,"mnc":1,"mncLength":2}},"ulCqiReport":{"cqiMeas":[{"servCellIndex":0,"type":"FLUCT_SRS"}],"pucchDbm":[{"p0PucchDbm":0,"servCellIndex":0}],"sfnSn":2209}},"rnti":18747},{"harq":["ACK","ACK","ACK","ACK","ACK","ACK","ACK","ACK"],"mac_stats":{"bsr":[0,0,0,0],"dlCqiReport":{"csiReport":[{"p10csi":{"wbCqi":15},"ri":0,"servCellIndex":0,"type":"FLCSIT_P10"}],"sfnSn":8509},"gtpStats":[{"eRabId":5,"teidEnb":2369645879,"teidSgw":2}],"macStats":{"harqRound":8,"macSdusDl":[{"lcid":3,"sduLength":4082}],"mcs1Dl":28,"mcs1Ul":20,"mcs2Dl":28,"mcs2Ul":20,"prbDl":44,"prbRetxDl":16,"prbRetxUl":0,"prbUl":0,"tbsDl":4107,"tbsUl":1908,"totalBytesSdusDl":32057,"totalBytesSdusUl":11576,"totalPduDl":42,"totalPduUl":31,"totalPrbDl":472,"totalPrbUl":338,"totalTbsDl":33558,"totalTbsUl":16654},"pdcpStats":{"pktRx":69,"pktRxAiat":109047,"pktRxAiatW":0,"pktRxBytes":8729,"pktRxBytesW":0,"pktRxOo":0,"pktRxSn":68,"pktRxW":0,"pktTx":81,"pktTxAiat":110278,"pktTxAiatW":0,"pktTxBytes":44491,"pktTxBytesW":0,"pktTxSn":80,"pktTxW":0,"sfn":"110906"},"pendingMacCes":0,"phr":33,"rlcReport":[{"lcId":1,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":199},{"lcId":2,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":0},{"lcId":3,"statusPduSize":0,"txQueueHolDelay":0,"txQueueSize":12830}],"rnti":39962,"rrcMeasurements":{"measid":-1,"pcellRsrp":-1,"pcellRsrq":-1},"s1apStats":{"enbUeS1apId":16398672,"mmeS1Ip":"172.22.0.9","mmeUeS1apId":2,"selectedPlmn":{"mcc":1,"mnc":1,"mncLength":2}},"ulCqiReport":{"cqiMeas":[{"servCellIndex":0,"type":"FLUCT_SRS"}],"pucchDbm":[{"p0PucchDbm":0,"servCellIndex":0}],"sfnSn":8509}},"rnti":39962}]}]}';
        // decoding the json fromat to simple array
        $decoded_cell_data = json_decode($json_data, true);

        // mapping the json data array to a cell one collecting the information needed
        $data['cell']['dlFreq'] = $decoded_cell_data['eNB_config'][0]['eNB']['cellConfig'][0]['dlFreq'];
        $data['cell']['ulFreq'] = $decoded_cell_data['eNB_config'][0]['eNB']['cellConfig'][0]['ulFreq'];
        $data['cell']['dlBandwidth'] = $decoded_cell_data['eNB_config'][0]['eNB']['cellConfig'][0]['dlBandwidth'];
        $data['cell']['ulBandwidth'] = $decoded_cell_data['eNB_config'][0]['eNB']['cellConfig'][0]['ulBandwidth'];
        $data['cell']['dlPdschPower'] = $decoded_cell_data['eNB_config'][0]['eNB']['cellConfig'][0]['dlPdschPower'];
        $data['cell']['ulPuschPower'] = $decoded_cell_data['eNB_config'][0]['eNB']['cellConfig'][0]['ulPuschPower'];

        // mapping the json data for users by looping trough them and collecting the information needed
        foreach($decoded_cell_data['mac_stats'][0]['ue_mac_stats'] as $user)
        {
            $user_data['rnti'] = $user['rnti'];
            $user_data['pcellRsrp'] = $user['mac_stats']['rrcMeasurements']['pcellRsrp'];
            $user_data['pcellRsrq'] = $user['mac_stats']['rrcMeasurements']['pcellRsrq'];
            $user_data['wbCqi'] = $user['mac_stats']['dlCqiReport']['csiReport'][0]['p10csi']['wbCqi'];
            $user_data['prbDl'] = $user['mac_stats']['macStats']['prbDl'];
            $user_data['prbUl'] = $user['mac_stats']['macStats']['prbUl'];
            $user_data['totalBytesSdusUl'] = $user['mac_stats']['macStats']['totalBytesSdusDl'];
            $user_data['totalBytesSdusDl'] = $user['mac_stats']['macStats']['totalBytesSdusUl'];
            $user_data['totalPrbDl'] = $user['mac_stats']['macStats']['totalPrbDl'];
            $user_data['totalPrbUl'] = $user['mac_stats']['macStats']['totalPrbUl'];

            array_push($data['users'],$user_data);
        }
        // returns the collected infromation as json
        return response()->json($data);
    }
}
